<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
<meta name="description" content="Make crypto charts cute! Because charts shouldn't be ugly.">
<meta property="og:title" content="Cute Crypto Charts">
<meta property="og:description" content="Make crypto charts cute! Because charts shouldn't be ugly.">
<meta property="og:image" content="https://cutecryptocharts.com/og-image.png">
<meta property="og:url" content="https://cutecryptocharts.com">
<meta property="og:type" content="website">
<meta name="twitter:card" content="summary_large_image">
<meta name="twitter:title" content="Cute Crypto Charts">
<meta name="twitter:description" content="Make crypto charts cute! Because charts shouldn't be ugly.">
<meta name="twitter:image" content="https://cutecryptocharts.com/og-image.png">
<link rel="icon" type="image/png" href="favicon.png">
<link rel="apple-touch-icon" href="favicon.png">
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Bangers&family=Space+Mono:wght@400;700&family=Fredoka:wght@400;600&family=Bubblegum+Sans&family=Press+Start+2P&family=Righteous&family=Pacifico&family=Bungee&display=swap" rel="stylesheet">
<title>Cute Crypto Charts</title>
<style>
  :root {
    --color-text: #e0e0e0;
    --color-chart-bg: #16213e;
    --color-page-bg: #1a1a2e;
    --color-active-bg: #0f3460;
    --color-active-border: #4a7cbb;
    --font-family: 'Bangers', cursive;
  }
  * { margin: 0; padding: 0; box-sizing: border-box; }
  body {
    background: var(--color-page-bg);
    color: var(--color-text);
    font-family: var(--font-family);
    height: 100vh;
    height: 100dvh;
    display: flex;
    flex-direction: column;
    align-items: center;
    padding: 20px;
    padding-bottom: 150px;
    overflow: hidden;
  }
  .logo {
    position: absolute;
    top: 16px;
    left: 16px;
    height: 8vh;
  }
  .logo img {
    height: 100%;
    width: auto;
  }
  @media (max-width: 600px) {
    .logo {
      position: static;
      display: flex;
      justify-content: center;
      margin-bottom: 8px;
      height: 6vh;
    }
  }
  h1 { font-size: 1.5rem; margin-bottom: 8px; color: var(--color-text); flex-shrink: 0; }
  .subtitle { color: var(--color-text); opacity: 0.6; font-size: 0.85rem; margin-bottom: 8px; flex-shrink: 0; }
  .customize-panel {
    background: var(--color-chart-bg);
    border: 1px solid rgba(255,255,255,0.1);
    border-radius: 12px 12px 0 0;
    position: fixed;
    bottom: 0;
    left: 50%;
    transform: translateX(-50%);
    width: 100%;
    max-width: 1100px;
    z-index: 50;
    padding-bottom: env(safe-area-inset-bottom, 0px);
  }
  .customize-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 8px 16px;
    cursor: pointer;
    user-select: none;
  }
  .customize-header span {
    font-size: 0.85rem;
    color: var(--color-text);
    opacity: 0.7;
    letter-spacing: 1px;
    text-transform: uppercase;
  }
  .customize-toggle {
    background: none;
    border: none;
    color: var(--color-text);
    opacity: 0.5;
    font-size: 1rem;
    cursor: pointer;
    transition: transform 0.2s;
    padding: 0 4px;
  }
  .customize-panel.collapsed .customize-toggle {
    transform: rotate(180deg);
  }
  .customize-panel.collapsed .controls {
    display: none;
  }
  .controls {
    display: flex;
    gap: 20px;
    align-items: center;
    flex-wrap: wrap;
    justify-content: center;
    padding: 0 16px 12px;
    flex-shrink: 0;
  }
  .emoji-picker {
    display: flex;
    align-items: center;
    gap: 6px;
    position: relative;
  }
  .emoji-picker label { font-size: 0.85rem; color: var(--color-text); opacity: 0.7; }
  .emoji-btn {
    width: 50px;
    height: 40px;
    font-size: 1.5rem;
    text-align: center;
    border: 1px solid #333;
    border-radius: 8px;
    background: var(--color-chart-bg);
    cursor: pointer;
    padding: 0;
    line-height: 40px;
  }
  .emoji-popup {
    display: none;
    position: absolute;
    bottom: 100%;
    left: 0;
    z-index: 100;
    background: var(--color-chart-bg);
    border: 1px solid #444;
    border-radius: 10px;
    padding: 8px;
    width: 260px;
    max-height: 220px;
    overflow-y: auto;
    box-shadow: 0 8px 24px rgba(0,0,0,0.5);
    margin-bottom: 4px;
  }
  .emoji-popup.open { display: flex; flex-wrap: wrap; gap: 2px; }
  @media (max-width: 600px) {
    .emoji-popup {
      position: fixed;
      top: auto;
      bottom: 0;
      left: 0;
      right: 0;
      width: 100%;
      max-height: 50vh;
      border-radius: 16px 16px 0 0;
      padding: 16px;
      gap: 4px;
      justify-content: center;
    }
    .emoji-popup span {
      font-size: 1.6rem;
      width: 44px;
      height: 44px;
    }
  }
  .emoji-popup span {
    font-size: 1.3rem;
    width: 32px;
    height: 32px;
    display: flex;
    align-items: center;
    justify-content: center;
    cursor: pointer;
    border-radius: 6px;
    transition: background 0.15s;
  }
  .emoji-popup span:hover { background: rgba(255,255,255,0.1); }
  .color-picker {
    display: flex;
    align-items: center;
    gap: 6px;
  }
  .color-picker label { font-size: 0.75rem; color: var(--color-text); opacity: 0.7; }
  .color-picker select {
    height: 32px;
    border: 1px solid #333;
    border-radius: 6px;
    background: var(--color-chart-bg);
    color: var(--color-text);
    font-family: var(--font-family);
    font-size: 0.8rem;
    padding: 0 6px;
    cursor: pointer;
  }
  .color-picker input[type="color"] {
    width: 32px;
    height: 32px;
    border: 1px solid #333;
    border-radius: 6px;
    background: none;
    cursor: pointer;
    padding: 2px;
  }
  .bottom-bar {
    display: flex;
    justify-content: space-between;
    align-items: center;
    width: 100%;
    max-width: 1100px;
    padding: 8px 0;
    flex-shrink: 0;
  }
  .bottom-bar .subtitle {
    margin-bottom: 0;
  }
  .timeframe-btns {
    display: flex;
    gap: 6px;
    align-items: center;
  }
  .zoom-separator {
    color: var(--color-text);
    opacity: 0.3;
    margin: 0 2px;
    user-select: none;
  }
  .timeframe-btns button {
    padding: 8px 16px;
    border: 1px solid var(--color-text);
    border-radius: 8px;
    background: transparent;
    color: var(--color-text);
    cursor: pointer;
    font-family: var(--font-family);
    font-size: 0.9rem;
    transition: background 0.2s, border-color 0.2s;
  }
  .timeframe-btns button:hover { background: rgba(255,255,255,0.05); }
  .timeframe-btns button.active {
    background: var(--color-active-bg);
    border-color: var(--color-active-border);
    color: var(--color-text);
  }
  .chart-container {
    width: 100%;
    max-width: 1100px;
    flex: 1;
    min-height: 0;
    background: var(--color-chart-bg);
    border-radius: 12px;
    padding: 20px;
    position: relative;
    display: flex;
    flex-direction: column;
  }
  .chart-grid {
    display: grid;
    grid-template-columns: 1fr 50px;
    grid-template-rows: 1fr 36px;
    flex: 1;
    min-height: 0;
  }
  .candles-scroll {
    grid-column: 1;
    grid-row: 1;
    overflow-x: auto;
    overflow-y: auto;
    border-right: 1px solid #333;
    border-bottom: 1px solid #333;
  }
  .candles-area {
    display: flex;
    align-items: flex-end;
    gap: 2px;
    padding: 0 4px;
    min-width: max-content;
  }
  .y-axis {
    grid-column: 2;
    grid-row: 1;
    overflow: hidden;
    padding-left: 6px;
    text-align: left;
    font-size: 0.75rem;
    color: var(--color-text);
    opacity: 0.6;
  }
  .y-axis-inner {
    display: flex;
    flex-direction: column;
    justify-content: space-between;
    position: relative;
  }
  .price-tag {
    position: absolute;
    left: 0;
    right: 0;
    transform: translateY(50%);
    font-size: 0.75rem;
    font-weight: bold;
    color: var(--color-page-bg);
    pointer-events: none;
    white-space: nowrap;
    z-index: 1;
  }
  .price-tag-label {
    background: var(--color-text);
    padding: 2px 8px;
    border-radius: 4px;
    line-height: 20px;
    display: block;
    text-align: left;
  }
  .x-axis-scroll {
    grid-column: 1;
    grid-row: 2;
    overflow: hidden;
    position: relative;
  }
  .x-axis {
    display: flex;
    gap: 2px;
    padding: 6px 4px 0 4px;
    min-width: max-content;
  }
  .x-label {
    font-size: 0.6rem;
    color: var(--color-text);
    opacity: 0.5;
    text-align: center;
    white-space: nowrap;
  }
  .chart-corner {
    grid-column: 2;
    grid-row: 2;
  }
  .candle-col {
    display: flex;
    flex-direction: column;
    align-items: center;
    min-width: 22px;
  }
  .candle-inner {
    display: flex;
    flex-direction: column;
    align-items: center;
    width: 100%;
  }
  .wick {
    width: 2px;
    background: #555;
  }
  .candle-body {
    display: flex;
    flex-direction: column;
    align-items: center;
    line-height: 1;
  }
  .candle-body .emoji {
    font-size: 14px;
    line-height: 16px;
    height: 16px;
  }
  .x-label-cell {
    min-width: 22px;
    text-align: center;
    font-size: 0.75rem;
    color: var(--color-text);
    opacity: 0.5;
  }
  .coin-select-wrap {
    position: relative;
    display: inline-block;
  }
  .coin-select-wrap::after {
    content: 'â–¼';
    position: absolute;
    right: 10px;
    top: 50%;
    transform: translateY(-50%);
    color: var(--color-text);
    font-size: 0.6rem;
    pointer-events: none;
  }
  .coin-select {
    background: transparent;
    border: 1px solid var(--color-text);
    border-radius: 8px;
    color: var(--color-text);
    font-family: var(--font-family);
    font-size: 0.9rem;
    padding: 8px 28px 8px 16px;
    cursor: pointer;
    -webkit-appearance: none;
    -moz-appearance: none;
    appearance: none;
  }
  .coin-select option {
    background: var(--color-chart-bg);
    color: var(--color-text);
  }
  .loading {
    display: flex;
    align-items: center;
    justify-content: center;
    flex: 1;
    color: var(--color-text);
    opacity: 0.6;
    font-size: 1rem;
  }
  .error { color: #e94560; }
  .footer-credit {
    font-size: 0.65rem;
    color: var(--color-text);
    opacity: 0.4;
    text-align: center;
    max-width: 1100px;
    width: 100%;
    padding: 8px 0;
    word-break: break-all;
    letter-spacing: 0.1em;
  }
  .delulu-toggle {
    display: flex;
    align-items: center;
    gap: 8px;
  }
  .delulu-toggle label {
    font-size: 0.85rem;
    color: var(--color-text);
    cursor: pointer;
    user-select: none;
  }
  .delulu-switch {
    position: relative;
    width: 48px;
    height: 26px;
    background: rgba(255,255,255,0.15);
    border-radius: 13px;
    cursor: pointer;
    transition: background 0.3s;
  }
  .delulu-switch::after {
    content: '';
    position: absolute;
    top: 3px;
    left: 3px;
    width: 20px;
    height: 20px;
    background: var(--color-text);
    border-radius: 50%;
    transition: transform 0.3s;
  }
  @keyframes rainbow {
    0% { background-position: 0% 50%; }
    50% { background-position: 100% 50%; }
    100% { background-position: 0% 50%; }
  }
  .delulu-switch.active {
    background: linear-gradient(90deg, #ff0000, #ff7f00, #ffff00, #00ff00, #0000ff, #4b0082, #9400d3, #ff0000);
    background-size: 400% 400%;
    animation: rainbow 2s ease infinite;
  }
  .delulu-switch.active::after {
    transform: translateX(22px);
  }
  .delulu-active .logo svg {
    animation: rainbow-text 2s ease infinite;
  }
  @keyframes rainbow-text {
    0% { color: #ff0000; }
    14% { color: #ff7f00; }
    28% { color: #ffff00; }
    42% { color: #00ff00; }
    57% { color: #0000ff; }
    71% { color: #4b0082; }
    85% { color: #9400d3; }
    100% { color: #ff0000; }
  }
  @media (max-width: 600px) {
    .delulu-toggle label {
      font-size: 0.75rem;
    }
  }
</style>
</head>
<body>

<div class="logo">
  <svg width="297" height="153" viewBox="0 0 297 153" fill="none" xmlns="http://www.w3.org/2000/svg" style="height:100%;width:auto;">
    <g clip-path="url(#clip0_3104_74)">
      <path d="M141.073 62.2368C138.757 62.2368 137.016 61.34 135.849 59.5464C134.682 57.7354 134.099 55.0276 134.099 51.423C134.099 47.8184 134.7 45.1193 135.901 43.3257C137.103 41.5147 138.905 40.6092 141.308 40.6092C142.614 40.6092 143.729 40.8965 144.651 41.4712C145.574 42.0458 146.306 42.8904 146.846 44.0049C147.403 45.1193 147.742 46.495 147.864 48.1319H146.114C145.905 46.2164 145.4 44.771 144.599 43.7959C143.798 42.8207 142.701 42.3332 141.308 42.3332C139.514 42.3332 138.174 43.0819 137.286 44.5795C136.397 46.0771 135.953 48.3582 135.953 51.423C135.953 54.4878 136.371 56.7689 137.207 58.2665C138.06 59.7641 139.349 60.5128 141.073 60.5128C142.414 60.5128 143.476 60.0688 144.26 59.1807C145.043 58.2752 145.54 56.9344 145.748 55.1582H147.499C147.359 56.6906 147.02 57.9879 146.48 59.0501C145.957 60.0949 145.235 60.8872 144.312 61.427C143.406 61.9669 142.327 62.2368 141.073 62.2368ZM152.466 46.3818H157.926V47.6878H158.552C158.901 47.1306 159.354 46.7214 159.911 46.4602C160.485 46.1815 161.165 46.0422 161.948 46.0422C163.219 46.0422 164.221 46.4514 164.952 47.2699C165.683 48.0709 166.049 49.1941 166.049 50.6394V52.9902H164.194V50.979C164.194 48.8023 163.272 47.7139 161.426 47.7139C160.294 47.7139 159.441 48.1667 158.866 49.0722C158.291 49.9777 158.004 51.3359 158.004 53.1469V60.2255H163.359V61.8711H153.119V60.2255H156.228V48.0274H152.466V46.3818ZM170.442 46.3818H172.401L177.077 58.9717H178.54L178.043 60.5651H175.745L170.442 46.3818ZM184.26 46.3818L177.86 64.5615C177.512 65.5018 177.051 66.2158 176.476 66.7033C175.901 67.2083 175.231 67.4608 174.465 67.4608C173.403 67.4608 172.584 67.1474 172.01 66.5205C171.452 65.911 171.104 64.9881 170.965 63.7518H172.636C172.793 64.4657 173.002 64.9881 173.263 65.319C173.542 65.6672 173.925 65.8414 174.413 65.8414C174.813 65.8414 175.153 65.6934 175.431 65.3973C175.727 65.1187 175.997 64.666 176.241 64.0391L182.431 46.3818H184.26ZM189.698 67.0951V46.3818H191.474V48.2102H192.101C192.502 47.5311 193.076 47 193.825 46.6169C194.591 46.2338 195.444 46.0422 196.385 46.0422C197.691 46.0422 198.805 46.3644 199.728 47.0087C200.669 47.653 201.382 48.5846 201.87 49.8035C202.375 51.0051 202.628 52.4504 202.628 54.1395C202.628 55.8286 202.375 57.2739 201.87 58.4755C201.382 59.677 200.669 60.6086 199.728 61.2703C198.805 61.9146 197.691 62.2368 196.385 62.2368C195.444 62.2368 194.591 62.0452 193.825 61.6621C193.076 61.2616 192.502 60.7218 192.101 60.0427H191.474V67.0951H189.698ZM196.124 60.5912C197.621 60.5912 198.779 60.0253 199.598 58.8934C200.433 57.7441 200.851 56.1508 200.851 54.1134C200.851 52.0934 200.433 50.5175 199.598 49.3856C198.779 48.2537 197.621 47.6878 196.124 47.6878C194.626 47.6878 193.459 48.2537 192.623 49.3856C191.788 50.5175 191.37 52.1021 191.37 54.1395C191.37 56.1595 191.788 57.7441 192.623 58.8934C193.459 60.0253 194.626 60.5912 196.124 60.5912ZM212.506 42.5944V46.3818H219.794V48.0274H212.506V57.0389C212.506 58.1881 212.75 59.0675 213.237 59.677C213.725 60.2865 214.43 60.5912 215.353 60.5912C216.346 60.5912 217.112 60.2691 217.652 59.6248C218.209 58.963 218.557 57.9879 218.697 56.6993H220.342C220.22 58.5103 219.733 59.886 218.879 60.8263C218.044 61.7666 216.859 62.2368 215.327 62.2368C213.829 62.2368 212.689 61.7927 211.905 60.9046C211.122 60.0166 210.73 58.7454 210.73 57.0911V48.0274H206.969V46.3818H210.73V42.5944H212.506ZM232.127 62.2368C230.752 62.2368 229.568 61.9146 228.575 61.2703C227.583 60.6086 226.816 59.677 226.277 58.4755C225.754 57.2739 225.493 55.8286 225.493 54.1395C225.493 52.4504 225.754 51.0051 226.277 49.8035C226.816 48.5846 227.583 47.653 228.575 47.0087C229.568 46.3644 230.752 46.0422 232.127 46.0422C233.503 46.0422 234.687 46.3644 235.68 47.0087C236.672 47.653 237.43 48.5846 237.952 49.8035C238.492 51.0051 238.762 52.4504 238.762 54.1395C238.762 55.8286 238.492 57.2739 237.952 58.4755C237.43 59.677 236.672 60.6086 235.68 61.2703C234.687 61.9146 233.503 62.2368 232.127 62.2368ZM232.127 60.5912C233.66 60.5912 234.853 60.0253 235.706 58.8934C236.559 57.7441 236.986 56.1595 236.986 54.1395C236.986 52.1021 236.559 50.5175 235.706 49.3856C234.853 48.2537 233.66 47.6878 232.127 47.6878C230.595 47.6878 229.402 48.2537 228.549 49.3856C227.696 50.5175 227.269 52.1021 227.269 54.1395C227.269 56.1595 227.696 57.7441 228.549 58.8934C229.402 60.0253 230.595 60.5912 232.127 60.5912Z" fill="currentColor"/>
      <path d="M55.9879 74.3126H60.5052V78.83H55.9879V74.3126ZM51.4705 74.3126H55.9879V78.83H51.4705V74.3126ZM51.4705 78.83H55.9879V83.3473H51.4705V78.83ZM55.9879 78.83H60.5052V83.3473H55.9879V78.83ZM60.5052 78.83H65.0226V83.3473H60.5052V78.83ZM60.5052 74.3126H65.0226V78.83H60.5052V74.3126ZM65.0226 74.3126H69.54V78.83H65.0226V74.3126ZM69.54 74.3126H74.0574V78.83H69.54V74.3126ZM69.54 78.83H74.0574V83.3473H69.54V78.83ZM65.0226 78.83H69.54V83.3473H65.0226V78.83ZM69.54 83.3473H74.0574V87.8647H69.54V83.3473ZM74.0574 78.83H78.5747V83.3473H74.0574V78.83ZM74.0574 83.3473H78.5747V87.8647H74.0574V83.3473ZM74.0574 105.934H78.5747V110.452H74.0574V105.934ZM74.0574 110.452H78.5747V114.969H74.0574V110.452ZM69.54 110.452H74.0574V114.969H69.54V110.452ZM69.54 105.934H74.0574V110.452H69.54V105.934ZM65.0226 110.452H69.54V114.969H65.0226V110.452ZM69.54 114.969H74.0574V119.486H69.54V114.969ZM65.0226 114.969H69.54V119.486H65.0226V114.969ZM60.5052 114.969H65.0226V119.486H60.5052V114.969ZM60.5052 110.452H65.0226V114.969H60.5052V110.452ZM55.9879 114.969H60.5052V119.486H55.9879V114.969ZM51.4705 114.969H55.9879V119.486H51.4705V114.969ZM51.4705 110.452H55.9879V114.969H51.4705V110.452ZM55.9879 110.452H60.5052V114.969H55.9879V110.452ZM55.9879 105.934H60.5052V110.452H55.9879V105.934ZM51.4705 105.934H55.9879V110.452H51.4705V105.934ZM46.9531 110.452H51.4705V114.969H46.9531V110.452ZM46.9531 105.934H51.4705V110.452H46.9531V105.934ZM46.9531 101.417H51.4705V105.934H46.9531V101.417ZM46.9531 96.8995H51.4705V101.417H46.9531V96.8995ZM46.9531 92.3821H51.4705V96.8995H46.9531V92.3821ZM46.9531 87.8647H51.4705V92.3821H46.9531V87.8647ZM46.9531 83.3473H51.4705V87.8647H46.9531V83.3473ZM51.4705 83.3473H55.9879V87.8647H51.4705V83.3473ZM46.9531 78.83H51.4705V83.3473H46.9531V78.83ZM55.9879 83.3473H60.5052V87.8647H55.9879V83.3473ZM51.4705 87.8647H55.9879V92.3821H51.4705V87.8647ZM51.4705 92.3821H55.9879V96.8995H51.4705V92.3821ZM51.4705 96.8995H55.9879V101.417H51.4705V96.8995ZM51.4705 101.417H55.9879V105.934H51.4705V101.417ZM83.1039 87.8647H87.6212V92.3821H83.1039V87.8647ZM83.1039 83.3473H87.6212V87.8647H83.1039V83.3473ZM87.6212 83.3473H92.1386V87.8647H87.6212V83.3473ZM87.6212 87.8647H92.1386V92.3821H87.6212V87.8647ZM87.6212 92.3821H92.1386V96.8995H87.6212V92.3821ZM87.6212 96.8995H92.1386V101.417H87.6212V96.8995ZM87.6212 101.417H92.1386V105.934H87.6212V101.417ZM83.1039 101.417H87.6212V105.934H83.1039V101.417ZM83.1039 96.8995H87.6212V101.417H83.1039V96.8995ZM83.1039 92.3821H87.6212V96.8995H83.1039V92.3821ZM83.1039 105.934H87.6212V110.452H83.1039V105.934ZM87.6212 105.934H92.1386V110.452H87.6212V105.934ZM87.6212 110.452H92.1386V114.969H87.6212V110.452ZM87.6212 114.969H92.1386V119.486H87.6212V114.969ZM83.1039 114.969H87.6212V119.486H83.1039V114.969ZM83.1039 110.452H87.6212V114.969H83.1039V110.452ZM105.691 114.969H110.208V119.486H105.691V114.969ZM110.208 114.969H114.725V119.486H110.208V114.969ZM110.208 110.452H114.725V114.969H110.208V110.452ZM110.208 105.934H114.725V110.452H110.208V105.934ZM110.208 101.417H114.725V105.934H110.208V101.417ZM110.208 96.8995H114.725V101.417H110.208V96.8995ZM110.208 92.3821H114.725V96.8995H110.208V92.3821ZM110.208 87.8647H114.725V92.3821H110.208V87.8647ZM105.691 96.8995H110.208V101.417H105.691V96.8995ZM105.691 101.417H110.208V105.934H105.691V101.417ZM105.691 105.934H110.208V110.452H105.691V105.934ZM105.691 110.452H110.208V114.969H105.691V110.452ZM105.691 92.3821H110.208V96.8995H105.691V92.3821ZM92.1386 87.8647H96.656V92.3821H92.1386V87.8647ZM96.656 87.8647H101.173V92.3821H96.656V87.8647ZM101.173 87.8647H105.691V92.3821H101.173V87.8647ZM101.173 83.3473H105.691V87.8647H101.173V83.3473ZM105.691 83.3473H110.208V87.8647H105.691V83.3473ZM105.691 87.8647H110.208V92.3821H105.691V87.8647ZM96.656 83.3473H101.173V87.8647H96.656V83.3473ZM83.1039 74.3126H87.6212V78.83H83.1039V74.3126ZM87.6212 74.3126H92.1386V78.83H87.6212V74.3126ZM87.6212 78.83H92.1386V83.3473H87.6212V78.83ZM83.1039 78.83H87.6212V83.3473H83.1039V78.83ZM146.359 119.486H141.841V114.969H146.359V119.486ZM146.359 114.969H141.841V110.452H146.359V114.969ZM141.841 114.969H137.324V110.452H141.841V114.969ZM137.324 119.486H132.807V114.969H137.324V119.486ZM132.807 119.486H128.289V114.969H132.807V119.486ZM128.289 119.486H123.772V114.969H128.289V119.486ZM128.289 114.969H123.772V110.452H128.289V114.969ZM132.807 114.969H128.289V110.452H132.807V114.969ZM123.772 114.969H119.255V110.452H123.772V114.969ZM123.772 110.452H119.255V105.934H123.772V110.452ZM123.772 92.3821H119.255V87.8647H123.772V92.3821ZM128.289 92.3821H123.772V87.8647H128.289V92.3821ZM128.289 110.452H123.772V105.934H128.289V110.452ZM132.807 92.3821H128.289V87.8647H132.807V92.3821ZM128.289 87.8647H123.772V83.3473H128.289V87.8647ZM132.807 87.8647H128.289V83.3473H132.807V87.8647ZM137.324 87.8647H132.807V83.3473H137.324V87.8647ZM141.841 87.8647H137.324V83.3473H141.841V87.8647ZM146.359 87.8647H141.841V83.3473H146.359V87.8647ZM146.359 92.3821H141.841V87.8647H146.359V92.3821ZM141.841 92.3821H137.324V87.8647H141.841V92.3821ZM146.359 96.8995H141.841V92.3821H146.359V96.8995ZM150.876 92.3821H146.359V87.8647H150.876V92.3821ZM150.876 96.8995H146.359V92.3821H150.876V96.8995ZM150.876 101.417H146.359V96.8995H150.876V101.417ZM150.876 105.934H146.359V101.417H150.876V105.934ZM150.876 110.452H146.359V105.934H150.876V110.452ZM150.876 114.969H146.359V110.452H150.876V114.969ZM146.359 110.452H141.841V105.934H146.359V110.452ZM146.359 105.934H141.841V101.417H146.359V105.934ZM146.359 101.417H141.841V96.8995H146.359V101.417ZM137.324 92.3821H132.807V87.8647H137.324V92.3821ZM137.324 114.969H132.807V110.452H137.324V114.969ZM146.359 114.969H150.876V119.486H146.359V114.969ZM137.324 96.8995H141.841V101.417H137.324V96.8995ZM132.807 96.8995H137.324V101.417H132.807V96.8995ZM128.289 96.8995H132.807V101.417H128.289V96.8995ZM123.772 96.8995H128.289V101.417H123.772V96.8995ZM119.255 101.417H123.772V105.934H119.255V101.417ZM123.772 101.417H128.289V105.934H123.772V101.417ZM137.324 101.417H141.841V105.934H137.324V101.417ZM132.807 101.417H137.324V105.934H132.807V101.417ZM128.289 101.417H132.807V105.934H128.289V101.417ZM155.405 87.8647H159.923V92.3821H155.405V87.8647ZM155.405 83.3473H159.923V87.8647H155.405V83.3473ZM159.923 83.3473H164.44V87.8647H159.923V83.3473ZM159.923 87.8647H164.44V92.3821H159.923V87.8647ZM159.923 92.3821H164.44V96.8995H159.923V92.3821ZM159.923 96.8995H164.44V101.417H159.923V96.8995ZM159.923 101.417H164.44V105.934H159.923V101.417ZM155.405 101.417H159.923V105.934H155.405V101.417ZM155.405 96.8995H159.923V101.417H155.405V96.8995ZM155.405 92.3821H159.923V96.8995H155.405V92.3821ZM155.405 105.934H159.923V110.452H155.405V105.934ZM159.923 105.934H164.44V110.452H159.923V105.934ZM159.923 110.452H164.44V114.969H159.923V110.452ZM159.923 114.969H164.44V119.486H159.923V114.969ZM155.405 114.969H159.923V119.486H155.405V114.969ZM155.405 110.452H159.923V114.969H155.405V110.452ZM164.44 87.8647H168.957V92.3821H164.44V87.8647ZM168.957 87.8647H173.475V92.3821H168.957V87.8647ZM173.475 87.8647H177.992V92.3821H173.475V87.8647ZM173.475 83.3473H177.992V87.8647H173.475V83.3473ZM168.957 83.3473H173.475V87.8647H168.957V83.3473ZM164.44 92.3821H168.957V96.8995H164.44V92.3821ZM177.992 87.8647H182.51V92.3821H177.992V87.8647ZM173.475 92.3821H177.992V96.8995H173.475V92.3821ZM205.096 110.452H209.614V114.969H205.096V110.452ZM205.096 114.969H209.614V119.486H205.096V114.969ZM200.579 114.969H205.096V119.486H200.579V114.969ZM200.579 110.452H205.096V114.969H200.579V110.452ZM196.062 114.969H200.579V119.486H196.062V114.969ZM196.062 110.452H200.579V114.969H196.062V110.452ZM191.544 110.452H196.062V114.969H191.544V110.452ZM191.544 105.934H196.062V110.452H191.544V105.934ZM191.544 101.417H196.062V105.934H191.544V101.417ZM191.544 96.8995H196.062V101.417H191.544V96.8995ZM191.544 92.3821H196.062V96.8995H191.544V92.3821ZM191.544 87.8647H196.062V92.3821H191.544V87.8647ZM196.062 101.417H200.579V105.934H196.062V101.417ZM196.062 105.934H200.579V110.452H196.062V105.934ZM196.062 96.8995H200.579V101.417H196.062V96.8995ZM196.062 92.3821H200.579V96.8995H196.062V92.3821ZM196.062 74.3126H200.579V78.83H196.062V74.3126ZM196.062 78.83H200.579V83.3473H196.062V78.83ZM196.062 83.3473H200.579V87.8647H196.062V83.3473ZM196.062 87.8647H200.579V92.3821H196.062V87.8647ZM191.544 83.3473H196.062V87.8647H191.544V83.3473ZM187.027 87.8647H191.544V92.3821H187.027V87.8647ZM200.579 87.8647H205.096V92.3821H200.579V87.8647ZM205.096 87.8647H209.614V92.3821H205.096V87.8647ZM191.544 78.83H196.062V83.3473H191.544V78.83ZM187.027 92.3821H191.544V96.8995H187.027V92.3821ZM200.579 92.3821H205.096V96.8995H200.579V92.3821ZM205.096 92.3821H209.614V96.8995H205.096V92.3821ZM214.119 87.8647H218.637V92.3821H214.119V87.8647ZM218.637 92.3821H223.154V96.8995H218.637V92.3821ZM214.119 92.3821H218.637V96.8995H214.119V92.3821ZM214.119 96.8995H218.637V101.417H214.119V96.8995ZM218.637 96.8995H223.154V101.417H218.637V96.8995ZM218.637 101.417H223.154V105.934H218.637V101.417ZM223.154 101.417H227.672V105.934H223.154V101.417ZM227.672 101.417H232.189V105.934H227.672V101.417ZM232.189 96.8995H236.706V101.417H232.189V96.8995ZM227.672 96.8995H232.189V101.417H227.672V96.8995ZM223.154 96.8995H227.672V101.417H223.154V96.8995ZM232.189 101.417H236.706V105.934H232.189V101.417ZM236.706 101.417H241.224V105.934H236.706V101.417ZM236.706 105.934H241.224V110.452H236.706V105.934ZM232.189 105.934H236.706V110.452H232.189V105.934ZM232.189 110.452H236.706V114.969H232.189V110.452ZM236.706 110.452H241.224V114.969H236.706V110.452ZM232.189 114.969H236.706V119.486H232.189V114.969ZM227.672 110.452H232.189V114.969H227.672V110.452ZM223.154 110.452H227.672V114.969H223.154V110.452ZM218.637 110.452H223.154V114.969H218.637V110.452ZM214.119 110.452H218.637V114.969H214.119V110.452ZM218.637 114.969H223.154V119.486H218.637V114.969ZM223.154 114.969H227.672V119.486H223.154V114.969ZM227.672 114.969H232.189V119.486H227.672V114.969ZM236.706 87.8647H241.224V92.3821H236.706V87.8647ZM232.189 87.8647H236.706V92.3821H232.189V87.8647ZM232.189 83.3473H236.706V87.8647H232.189V83.3473ZM227.672 83.3473H232.189V87.8647H227.672V83.3473ZM223.154 83.3473H227.672V87.8647H223.154V83.3473ZM218.637 83.3473H223.154V87.8647H218.637V83.3473ZM218.637 87.8647H223.154V92.3821H218.637V87.8647ZM223.154 87.8647H227.672V92.3821H223.154V87.8647ZM227.672 87.8647H232.189V92.3821H227.672V87.8647Z" fill="currentColor"/>
      <path d="M67.7864 41.8558C66.6542 41.8558 65.8176 41.2582 65.2766 40.0631C65.025 39.4969 64.7734 39.1573 64.5218 39.044C64.3331 38.956 63.8361 38.912 63.031 38.912C61.4459 38.912 59.6154 40.1448 57.5396 42.6106C54.6335 46.0577 53.1805 49.2846 53.1805 52.2913C53.1805 53.6626 53.6397 54.8389 54.558 55.8201C55.4764 56.8014 56.5772 57.2921 57.8604 57.2921C59.1059 57.2921 60.3702 56.965 61.6534 56.3108C62.1063 56.0717 63.0624 55.4553 64.5218 54.4614C65.5031 53.8073 66.2453 53.4802 66.7485 53.4802C67.5034 53.4802 68.145 53.7569 68.6733 54.3105C69.164 54.8263 69.4093 55.4176 69.4093 56.0843C69.4093 56.8266 69.0822 57.4745 68.428 58.028C64.9684 60.9467 61.4459 62.406 57.8604 62.406C55.0298 62.406 52.6395 61.3744 50.6895 59.3112C48.8276 57.3235 47.8967 54.9835 47.8967 52.2913C47.8967 48.0768 49.7397 43.7743 53.4258 39.3837C56.5583 35.6599 59.7601 33.798 63.031 33.798C63.5845 33.798 64.0815 33.8168 64.5218 33.8546C64.9747 33.8923 65.371 33.9489 65.7106 34.0244C66.2642 33.4835 66.9309 33.213 67.7109 33.213C68.9942 33.213 69.7867 33.9489 70.0887 35.4209C70.3025 36.4776 70.4095 37.7105 70.4095 39.1195C70.4095 39.7486 70.227 40.321 69.8622 40.8368C69.3841 41.5161 68.6922 41.8558 67.7864 41.8558ZM89.3368 51.0458C89.3368 51.8887 89.3431 53.1594 89.3557 54.8577C89.3683 56.5561 89.3746 57.8267 89.3746 58.6696C89.3746 58.9338 89.3934 59.3301 89.4312 59.8585C89.4815 60.3743 89.5066 60.7643 89.5066 61.0285C89.5066 61.733 89.2487 62.3117 88.7329 62.7646C88.2297 63.23 87.607 63.4628 86.8647 63.4628C85.8206 63.4628 85.0594 62.991 84.5814 62.0475C82.9711 62.6388 81.3042 62.9344 79.5806 62.9344C77.7942 62.9344 76.2908 62.557 75.0705 61.8022C73.6993 60.9341 72.8815 59.6698 72.6173 58.0091C72.1267 54.864 71.8814 52.0523 71.8814 49.5739C71.8814 47.9385 72.0701 46.0703 72.4475 43.9693C72.6991 42.5477 73.5483 41.8369 74.995 41.8369C75.7247 41.8369 76.3475 42.0697 76.8633 42.5351C77.3791 42.988 77.637 43.5667 77.637 44.2712C77.637 44.8248 77.5426 45.6928 77.3539 46.8754C77.1778 48.058 77.0897 48.9575 77.0897 49.5739C77.0897 51.3478 77.1463 52.9015 77.2595 54.235C77.3853 55.5559 77.5678 56.6504 77.8068 57.5185C78.1213 57.6569 78.4232 57.7638 78.7126 57.8393C79.0145 57.9148 79.3039 57.9525 79.5806 57.9525C80.9771 57.9525 82.5119 57.7512 84.1851 57.3487C84.1851 56.38 84.1788 55.2792 84.1662 54.0463C84.1411 52.5744 84.1285 51.5176 84.1285 50.876C84.1285 48.297 84.248 46.0703 84.487 44.1958C84.6757 42.6987 85.5312 41.9501 87.0535 41.9501C87.7957 41.9501 88.431 42.1829 88.9594 42.6484C89.4878 43.1138 89.7331 43.6988 89.6954 44.4033C89.4563 49.1965 89.3368 51.4107 89.3368 51.0458ZM106.245 46.7622C105.981 46.7622 105.666 46.7559 105.301 46.7433C104.949 46.7181 104.641 46.7056 104.377 46.7056C103.861 46.7056 103.263 46.7559 102.584 46.8565C102.811 51.9391 102.924 55.2603 102.924 56.8203C102.924 56.9838 102.93 57.2921 102.943 57.7449C102.955 58.1853 102.961 58.5438 102.961 58.8206C102.961 61.7141 102.049 63.1609 100.225 63.1609C99.5333 63.1609 98.9357 62.947 98.4325 62.5192C97.879 62.0663 97.6022 61.5002 97.6022 60.8209C97.6022 60.368 97.6211 59.6886 97.6588 58.7828C97.6965 57.877 97.7154 57.1977 97.7154 56.7448C97.7154 55.2226 97.6022 51.9642 97.3757 46.9698C96.5958 46.932 95.4132 46.8314 93.828 46.6678C92.2555 46.4917 91.4692 45.674 91.4692 44.2146C91.4692 43.5101 91.7082 42.9125 92.1863 42.4219C92.6644 41.9313 93.2808 41.6859 94.0356 41.6859C94.5011 41.6859 95.5704 41.7614 97.2437 41.9124C97.2311 41.5098 97.1996 40.8431 97.1493 39.9121C97.099 39.1069 97.0738 38.4842 97.0738 38.0439C97.0738 37.3394 97.3317 36.7544 97.8475 36.2889C98.3633 35.8234 98.9861 35.5907 99.7157 35.5907C101.578 35.5907 102.509 37.157 102.509 40.2895L102.471 41.8369C103.251 41.7237 103.886 41.6671 104.377 41.6671C105.824 41.6671 106.811 41.7614 107.339 41.9501C108.346 42.3024 108.849 43.0698 108.849 44.2524C108.849 44.9695 108.604 45.567 108.113 46.0451C107.623 46.5231 107 46.7622 106.245 46.7622ZM120.662 62.8212C117.656 62.8212 115.196 62.1041 113.284 60.6699C111.17 59.0848 110.113 56.8517 110.113 53.9708C110.113 50.7879 110.95 48.0957 112.623 45.8941C114.485 43.4535 116.995 42.2332 120.153 42.2332C122.342 42.2332 124.16 42.5855 125.606 43.29C127.506 44.2209 128.456 45.6677 128.456 47.6302C128.456 49.0141 127.682 50.2407 126.135 51.31C125.43 51.8007 124.015 52.5178 121.889 53.4613L115.529 56.273C116.133 56.9272 116.863 57.4179 117.718 57.7449C118.574 58.072 119.555 58.2356 120.662 58.2356C122.348 58.2356 123.776 57.8896 124.946 57.1977C125.99 56.5813 126.827 56.273 127.456 56.273C128.764 56.273 129.418 56.9083 129.418 58.179C129.418 59.6132 128.368 60.7831 126.267 61.6889C124.506 62.4438 122.637 62.8212 120.662 62.8212ZM120.153 46.7999C118.983 46.7999 117.983 47.1899 117.152 47.9699C116.322 48.7499 115.655 49.9199 115.152 51.4799C116.574 50.8634 117.989 50.2533 119.398 49.6494C121.096 48.882 122.449 48.1712 123.455 47.517C122.612 47.0389 121.511 46.7999 120.153 46.7999Z" fill="currentColor"/>
    </g>
    <defs>
      <clipPath id="clip0_3104_74">
        <rect width="297" height="153" fill="white"/>
      </clipPath>
    </defs>
  </svg>
</div>

<div class="bottom-bar">
  <div class="timeframe-btns">
    <button class="active" data-interval="1m">1m</button>
    <button data-interval="30m">30m</button>
    <button data-interval="1d">1d</button>
    <button id="zoomOut" style="display:none;">âˆ’</button>
    <button id="zoomIn" style="display:none;">+</button>
  </div>
  <div class="delulu-toggle">
    <label for="deluluSwitch">DeLuLu</label>
    <div class="delulu-switch" id="deluluSwitch"></div>
  </div>
  <div class="coin-select-wrap">
    <select id="coinPicker" class="coin-select">
      <option value="SOL" selected>SOL / USDT</option>
      <option value="BTC">BTC / USDT</option>
      <option value="ETH">ETH / USDT</option>
    </select>
  </div>
</div>

<div class="chart-container">
  <div id="chart" class="loading">Loading...</div>
</div>

<div class="footer-credit">
  Website by Bangerz. Funded by Bags App: G3gpLJVta6TY7UQS7dFHysm2jysDwhEJa2WHDW1rBAGS
</div>

<div class="customize-panel" id="customizePanel">
  <div class="customize-header" id="customizeHeader">
    <span>Customize</span>
    <button class="customize-toggle">â–²</button>
  </div>
  <div class="controls">
  <div class="emoji-picker" id="upPicker">
    <label>Up:</label>
    <button class="emoji-btn" id="upBtn">ðŸ˜Š</button>
    <div class="emoji-popup" id="upPopup"></div>
  </div>
  <div class="emoji-picker" id="downPicker">
    <label>Down:</label>
    <button class="emoji-btn" id="downBtn">ðŸ˜¡</button>
    <div class="emoji-popup" id="downPopup"></div>
  </div>
  <div class="color-picker">
    <label>Font</label>
    <select id="fontPicker">
      <option value="'Bangers', cursive" selected>Bangers</option>
      <option value="'Space Mono', monospace">Space Mono</option>
      <option value="Impact, sans-serif">Impact</option>
      <option value="'Comic Sans MS', 'Comic Sans', cursive">Comic Sans</option>
      <option value="'Fredoka', sans-serif">Fredoka</option>
      <option value="'Bubblegum Sans', cursive">Bubblegum Sans</option>
      <option value="'Press Start 2P', monospace">Press Start 2P</option>
      <option value="'Righteous', sans-serif">Righteous</option>
      <option value="'Pacifico', cursive">Pacifico</option>
      <option value="'Bungee', sans-serif">Bungee</option>
    </select>
  </div>
  </div>
  <div class="controls">
  <div class="color-picker">
    <label>Text</label>
    <input type="color" id="colorText" value="#e0e0e0">
  </div>
  <div class="color-picker">
    <label>Chart</label>
    <input type="color" id="colorChart" value="#16213e">
  </div>
  <div class="color-picker">
    <label>Page</label>
    <input type="color" id="colorPage" value="#1a1a2e">
  </div>
  </div>
</div>

<script>
const COINS = {
  SOL: { binance: 'SOLUSDT', kraken: 'SOLUSDT', krakenWs: 'SOL/USDT', label: 'SOL / USDT' },
  BTC: { binance: 'BTCUSDT', kraken: 'XBTUSDT', krakenWs: 'BTC/USDT', label: 'BTC / USDT' },
  ETH: { binance: 'ETHUSDT', kraken: 'ETHUSDT', krakenWs: 'ETH/USDT', label: 'ETH / USDT' },
};
let currentCoin = 'SOL';
let deluluMode = false;
const LIMIT = 200;
const EMOJI_HEIGHT = 16;
const Y_TICKS = 8;

let currentInterval = '1m';
let zoomLevel = 1;
const ZOOM_STEPS = [0.5, 0.75, 1, 1.5, 2, 3];
let upEmoji = 'ðŸ˜Š';
let downEmoji = 'ðŸ˜¡';
let savedUpEmoji = upEmoji;
let savedDownEmoji = downEmoji;

const chartEl = document.getElementById('chart');

// --- Emoji Picker ---
const EMOJI_LIST = [
  'ðŸ˜Š','ðŸ˜‚','ðŸ¤£','ðŸ˜','ðŸ˜Ž','ðŸ¥³','ðŸ¤©','ðŸ˜‡','ðŸ¥°','ðŸ˜',
  'ðŸ˜¡','ðŸ¤¬','ðŸ˜¤','ðŸ‘¿','ðŸ’€','â˜ ï¸','ðŸ”¥','ðŸ’¥','ðŸ’¢','ðŸ˜ˆ',
  'ðŸš€','ðŸ“ˆ','ðŸ“‰','ðŸ’°','ðŸ’¸','ðŸ¤‘','ðŸ’Ž','ðŸ†','â­','ðŸŒŸ',
  'â¤ï¸','ðŸ’š','ðŸ’›','ðŸ’œ','ðŸ–¤','ðŸ¤','ðŸ’™','ðŸ§¡','â£ï¸','ðŸ’—',
  'ðŸ‘','ðŸ‘Ž','ðŸ‘†','ðŸ‘‡','âœŒï¸','ðŸ¤ž','ðŸ«¡','ðŸ’ª','ðŸ‘','ðŸ™Œ',
  'ðŸ‚','ðŸ»','ðŸ¦','ðŸ¸','ðŸµ','ðŸ¦„','ðŸ','ðŸ¦…','ðŸ³','ðŸ”',
  'âœ…','âŒ','âš¡','ðŸ’¡','ðŸŽ¯','ðŸŽ²','ðŸŽ°','ðŸª™','ðŸ“Š','ðŸ§²',
  'ðŸ˜¢','ðŸ˜­','ðŸ¥º','ðŸ˜¿',
];

function populatePopup(popupEl, onSelect) {
  popupEl.innerHTML = '';
  EMOJI_LIST.forEach(e => {
    const span = document.createElement('span');
    span.textContent = e;
    span.addEventListener('click', (ev) => {
      ev.stopPropagation();
      onSelect(e);
      popupEl.classList.remove('open');
    });
    popupEl.appendChild(span);
  });
}

function setupEmojiPicker(btnId, popupId, initial, onSelect) {
  const btn = document.getElementById(btnId);
  const popup = document.getElementById(popupId);
  populatePopup(popup, (emoji) => {
    btn.textContent = emoji;
    onSelect(emoji);
    renderChart();
  });
  btn.addEventListener('click', (ev) => {
    ev.stopPropagation();
    // Close any other open popups
    document.querySelectorAll('.emoji-popup.open').forEach(p => {
      if (p !== popup) p.classList.remove('open');
    });
    popup.classList.toggle('open');
  });
}

setupEmojiPicker('upBtn', 'upPopup', upEmoji, v => { upEmoji = v; savedUpEmoji = v; });
setupEmojiPicker('downBtn', 'downPopup', downEmoji, v => { downEmoji = v; savedDownEmoji = v; });

// Close popups on outside click
document.addEventListener('click', () => {
  document.querySelectorAll('.emoji-popup.open').forEach(p => p.classList.remove('open'));
});

// --- Color Helpers ---
function hexToHsl(hex) {
  let r = parseInt(hex.slice(1,3),16)/255;
  let g = parseInt(hex.slice(3,5),16)/255;
  let b = parseInt(hex.slice(5,7),16)/255;
  const max = Math.max(r,g,b), min = Math.min(r,g,b);
  let h, s, l = (max+min)/2;
  if (max === min) { h = s = 0; }
  else {
    const d = max - min;
    s = l > 0.5 ? d/(2-max-min) : d/(max+min);
    if (max === r) h = ((g-b)/d + (g<b?6:0))/6;
    else if (max === g) h = ((b-r)/d+2)/6;
    else h = ((r-g)/d+4)/6;
  }
  return [h*360, s*100, l*100];
}

function hslToHex(h, s, l) {
  s /= 100; l /= 100;
  const a = s * Math.min(l, 1-l);
  const f = n => { const k = (n + h/30) % 12; return l - a * Math.max(Math.min(k-3, 9-k, 1), -1); };
  return '#' + [f(0),f(8),f(4)].map(x => Math.round(x*255).toString(16).padStart(2,'0')).join('');
}

function updateActiveColors(chartHex) {
  const [h, s, l] = hexToHsl(chartHex);
  // Active bg: shift lightness away from chart bg
  const activeBgL = l < 50 ? Math.min(l + 15, 90) : Math.max(l - 15, 10);
  // Active border: more saturated, shifted further in lightness
  const borderL = l < 50 ? Math.min(l + 30, 85) : Math.max(l - 30, 15);
  const borderS = Math.min(s + 20, 100);
  document.documentElement.style.setProperty('--color-active-bg', hslToHex(h, s, activeBgL));
  document.documentElement.style.setProperty('--color-active-border', hslToHex(h, borderS, borderL));
}

// --- Auto Text Color ---
function luminance(hex) {
  const r = parseInt(hex.slice(1,3),16)/255;
  const g = parseInt(hex.slice(3,5),16)/255;
  const b = parseInt(hex.slice(5,7),16)/255;
  // Relative luminance (WCAG)
  const toLinear = c => c <= 0.03928 ? c/12.92 : Math.pow((c+0.055)/1.055, 2.4);
  return 0.2126*toLinear(r) + 0.7152*toLinear(g) + 0.0722*toLinear(b);
}

function updateTextColor(pageBg, chartBg) {
  // Average luminance of both backgrounds
  const avg = (luminance(pageBg) + luminance(chartBg)) / 2;
  const textColor = avg < 0.4 ? '#e0e0e0' : '#1a1a1a';
  document.documentElement.style.setProperty('--color-text', textColor);
}

// --- Random Color Generation ---
function randomHex() {
  return '#' + Array.from({length: 3}, () =>
    Math.floor(Math.random()*256).toString(16).padStart(2,'0')
  ).join('');
}

function randomize() {
  // Random emojis (pick two different ones)
  const i1 = Math.floor(Math.random() * EMOJI_LIST.length);
  let i2 = Math.floor(Math.random() * EMOJI_LIST.length);
  while (i2 === i1) i2 = Math.floor(Math.random() * EMOJI_LIST.length);
  upEmoji = EMOJI_LIST[i1];
  downEmoji = EMOJI_LIST[i2];
  savedUpEmoji = upEmoji;
  savedDownEmoji = downEmoji;
  document.getElementById('upBtn').textContent = upEmoji;
  document.getElementById('downBtn').textContent = downEmoji;

  // Random colors
  const pageBg = randomHex();
  const chartBg = randomHex();
  document.documentElement.style.setProperty('--color-page-bg', pageBg);
  document.documentElement.style.setProperty('--color-chart-bg', chartBg);
  document.getElementById('colorPage').value = pageBg;
  document.getElementById('colorChart').value = chartBg;
  updateActiveColors(chartBg);
  // Auto pick text color for contrast
  updateTextColor(pageBg, chartBg);
  const textColor = getComputedStyle(document.documentElement).getPropertyValue('--color-text').trim();
  document.getElementById('colorText').value = textColor;
}

// Randomize on load
randomize();

// --- Color Pickers ---
const colorTextInput = document.getElementById('colorText');
const colorChartInput = document.getElementById('colorChart');
const colorPageInput = document.getElementById('colorPage');

colorTextInput.addEventListener('input', e => {
  document.documentElement.style.setProperty('--color-text', e.target.value);
});
colorChartInput.addEventListener('input', e => {
  document.documentElement.style.setProperty('--color-chart-bg', e.target.value);
  updateActiveColors(e.target.value);
});
colorPageInput.addEventListener('input', e => {
  document.documentElement.style.setProperty('--color-page-bg', e.target.value);
});

// --- Font Picker ---
document.getElementById('fontPicker').addEventListener('change', e => {
  document.documentElement.style.setProperty('--font-family', e.target.value);
});

// --- Customize Panel Toggle ---
function syncPanelPadding() {
  requestAnimationFrame(() => {
    const panel = document.getElementById('customizePanel');
    document.body.style.paddingBottom = (panel.offsetHeight + 28) + 'px';
    savedChartHeight = null;
    renderChart();
  });
}

document.getElementById('customizeHeader').addEventListener('click', () => {
  document.getElementById('customizePanel').classList.toggle('collapsed');
  syncPanelPadding();
});

// Set initial padding based on actual panel size
syncPanelPadding();

// --- DeLuLu Toggle ---
document.getElementById('deluluSwitch').addEventListener('click', () => {
  deluluMode = !deluluMode;
  document.getElementById('deluluSwitch').classList.toggle('active', deluluMode);
  document.body.classList.toggle('delulu-active', deluluMode);
  // Clear pending scroll so chart re-centers on the (boosted) current price
  pendingScrollRestore = null;
  renderChart();
});

// --- Coin picker ---
function applyCoinEmoji() {
  if (currentCoin === 'ETH') {
    upEmoji = 'ðŸ’©';
    downEmoji = 'ðŸ’©';
    document.getElementById('upBtn').textContent = 'ðŸ’©';
    document.getElementById('downBtn').textContent = 'ðŸ’©';
  } else {
    upEmoji = savedUpEmoji;
    downEmoji = savedDownEmoji;
    document.getElementById('upBtn').textContent = upEmoji;
    document.getElementById('downBtn').textContent = downEmoji;
  }
}

document.getElementById('coinPicker').addEventListener('change', e => {
  currentCoin = e.target.value;
  applyCoinEmoji();
  closeWebSocket();
  fetchAndRender();
});

// --- Timeframe buttons ---
document.querySelectorAll('[data-interval]').forEach(btn => {
  btn.addEventListener('click', () => {
    document.querySelectorAll('[data-interval]').forEach(b => b.classList.remove('active'));
    btn.classList.add('active');
    currentInterval = btn.dataset.interval;
    closeWebSocket();
    fetchAndRender();
  });
});

// --- Zoom controls (focal-point: center of visible area) ---
function buttonZoom(newZoom) {
  const candlesScroll = document.getElementById('candlesScroll');
  if (!candlesScroll) return;

  const oldZoom = zoomLevel;
  const centerX = candlesScroll.clientWidth / 2;
  const centerY = candlesScroll.clientHeight / 2;

  const contentX = candlesScroll.scrollLeft + centerX;
  const contentY = candlesScroll.scrollTop + centerY;
  const ratioX = candlesScroll.scrollWidth > 0 ? contentX / candlesScroll.scrollWidth : 0;
  const ratioY = candlesScroll.scrollHeight > 0 ? contentY / candlesScroll.scrollHeight : 0;

  const zoomRatio = newZoom / oldZoom;
  const newContentWidth = candlesScroll.scrollWidth * zoomRatio;
  const newContentHeight = candlesScroll.scrollHeight * zoomRatio;

  zoomLevel = newZoom;
  pendingScrollRestore = {
    scrollLeft: ratioX * newContentWidth - centerX,
    scrollTop: ratioY * newContentHeight - centerY,
  };
  renderChart();
}

document.getElementById('zoomIn').addEventListener('click', () => {
  const next = ZOOM_STEPS.find(s => s > zoomLevel);
  if (next !== undefined) buttonZoom(next);
});
document.getElementById('zoomOut').addEventListener('click', () => {
  const prev = [...ZOOM_STEPS].reverse().find(s => s < zoomLevel);
  if (prev !== undefined) buttonZoom(prev);
});

// --- Gesture zoom RAF throttle ---
let zoomRAF = null;
function scheduleRender() {
  if (zoomRAF) return;
  zoomRAF = requestAnimationFrame(() => {
    zoomRAF = null;
    renderChart();
  });
}

// --- Touch pinch-to-zoom state ---
let touchStartDist = null;
let touchStartZoom = null;
let touchMidX = 0;
let touchMidY = 0;
let touchScrollLeft = 0;
let touchScrollTop = 0;
let touchContentWidth = 0;
let touchContentHeight = 0;

// --- Chart ---
let candles = [];
let dataSource = 'Binance';

function updateSourceLabel() {}

// Binance interval -> Kraken interval (minutes)
const KRAKEN_INTERVALS = { '1m': 1, '30m': 30, '1d': 1440 };

async function fetchFromBinance() {
  const url = `https://api.binance.com/api/v3/klines?symbol=${COINS[currentCoin].binance}&interval=${currentInterval}&limit=${LIMIT}`;
  const res = await fetch(url);
  if (!res.ok) throw new Error(`Binance API error: ${res.status}`);
  const data = await res.json();
  return data.map(k => ({
    time: k[0],
    open: parseFloat(k[1]),
    high: parseFloat(k[2]),
    low: parseFloat(k[3]),
    close: parseFloat(k[4]),
  }));
}

async function fetchFromKraken() {
  const interval = KRAKEN_INTERVALS[currentInterval];
  const url = `https://api.kraken.com/0/public/OHLC?pair=${COINS[currentCoin].kraken}&interval=${interval}`;
  const res = await fetch(url);
  if (!res.ok) throw new Error(`Kraken API error: ${res.status}`);
  const data = await res.json();
  if (data.error && data.error.length) throw new Error(data.error[0]);
  const key = Object.keys(data.result).find(k => k !== 'last');
  const rows = data.result[key];
  // Kraken returns: [time, open, high, low, close, vwap, volume, count]
  // Take last LIMIT entries
  return rows.slice(-LIMIT).map(k => ({
    time: k[0] * 1000,
    open: parseFloat(k[1]),
    high: parseFloat(k[2]),
    low: parseFloat(k[3]),
    close: parseFloat(k[4]),
  }));
}

async function fetchCandles() {
  try {
    const result = await fetchFromBinance();
    dataSource = 'Binance';
    updateSourceLabel();
    return result;
  } catch (e) {
    const result = await fetchFromKraken();
    dataSource = 'Kraken';
    updateSourceLabel();
    return result;
  }
}

function formatTime(ts) {
  const d = new Date(ts);
  if (currentInterval === '1d') {
    return `${d.getMonth()+1}/${d.getDate()}`;
  }
  return `${d.getHours().toString().padStart(2,'0')}:${d.getMinutes().toString().padStart(2,'0')}`;
}

function shouldShowLabel(ts, idx) {
  const d = new Date(ts);
  if (currentInterval === '1m') {
    return d.getMinutes() % 5 === 0;
  } else if (currentInterval === '30m') {
    return d.getMinutes() === 0;
  } else {
    return idx % 5 === 0;
  }
}

let savedChartHeight = null;
window.addEventListener('resize', () => { savedChartHeight = null; renderChart(); });

// Pending scroll restoration after render (set by focal-point zoom)
let pendingScrollRestore = null;

function renderChart() {
  if (!candles.length) return;

  const container = document.querySelector('.chart-container');
  if (!savedChartHeight) {
    savedChartHeight = Math.max(200, container.clientHeight - 80);
  }
  const CHART_HEIGHT = savedChartHeight;
  // Always make content 50% taller than viewport for vertical scroll buffer
  const SCROLL_BUFFER = 1.5;
  const SCALED_HEIGHT = CHART_HEIGHT * Math.max(zoomLevel, 1) * SCROLL_BUFFER;

  const allHighs = candles.map(c => c.high);
  const allLows = candles.map(c => c.low);
  const rawMax = Math.max(...allHighs);
  const rawMin = Math.min(...allLows);
  const rawRange = rawMax - rawMin || 1;

  // Calculate DeLuLu boost first so we can extend the Y-axis range
  // DeLuLu is disabled for ETH
  const deluluActive = deluluMode && currentCoin !== 'ETH';
  let deluluBoost = 0;
  if (deluluActive) {
    const currentPrice = candles[candles.length - 1].close;
    // Check if natural range gives at least 20% gain appearance
    const priceMid = (rawMax + rawMin) / 2;
    const flippedPrice = priceMid + (priceMid - currentPrice);
    if (flippedPrice < currentPrice * 1.2) {
      deluluBoost = currentPrice * 0.5; // 50% boost
    } else {
      deluluBoost = flippedPrice - currentPrice;
    }
  }

  // Extend price range - include boosted prices in DeLuLu mode with extra padding at top
  const padding = rawRange * ((SCROLL_BUFFER - 1) / 2 + 0.2);
  const topPadding = deluluActive ? padding + deluluBoost + rawRange * 0.5 : padding;
  const priceMax = (deluluActive ? rawMax + deluluBoost : rawMax) + topPadding;
  const priceLow = rawMin - padding;
  const priceRange = priceMax - priceLow;

  const priceToPx = (p) => ((p - priceLow) / priceRange) * SCALED_HEIGHT;

  // In DeLuLu mode, flip vertically AND boost up
  const candlePriceToPx = (p) => {
    if (deluluActive) {
      // First flip the price around the midpoint of the original data
      const dataMid = (rawMax + rawMin) / 2;
      const flippedPrice = dataMid + (dataMid - p);
      // Then boost it up
      const boostedPrice = flippedPrice + deluluBoost;
      return priceToPx(boostedPrice);
    }
    return priceToPx(p);
  };

  const bodySizes = candles.map(c => Math.abs(c.close - c.open));
  // Use median body size for scaling so outliers don't shrink everything
  const sortedBodies = [...bodySizes].sort((a, b) => a - b);
  const medianBody = sortedBodies[Math.floor(sortedBodies.length / 2)] || 1;
  const maxBody = Math.max(medianBody * 3, Math.max(...bodySizes) || 1);
  const MIN_EMOJIS = currentInterval === '1m' ? 3 : 1;
  const MAX_EMOJIS = 10;

  // Format price for display â€” use K notation only for BTC-level prices
  const formatPrice = (p) => {
    if (p >= 10000) {
      return (p / 1000).toFixed(1) + 'K';
    } else if (p >= 1000) {
      return Math.round(p).toLocaleString();
    }
    return p.toFixed(1);
  };

  // Y-axis labels â€” more ticks when zoomed in
  const effectiveTicks = Math.round(Y_TICKS * Math.max(zoomLevel, 1));
  const rawStep = priceRange / (effectiveTicks - 1);
  // Round step to a nice number based on price magnitude
  let tickStep;
  if (priceMax >= 10000) {
    tickStep = Math.max(500, Math.round(rawStep / 500) * 500);
  } else if (priceMax >= 1000) {
    tickStep = Math.max(50, Math.round(rawStep / 50) * 50);
  } else {
    tickStep = Math.max(0.1, Math.round(rawStep * 10) / 10);
  }
  let yAxisHtml = '';
  for (let p = priceMax; p >= priceLow - 0.001; p -= tickStep) {
    yAxisHtml += `<div>${formatPrice(p)}</div>`;
  }

  let candlesHtml = '';
  let xAxisHtml = '';
  candles.forEach((c, idx) => {
    const isUp = c.close >= c.open;
    // In DeLuLu mode, flip the emoji so drops look like pumps
    // In DeLuLu mode, flip the emoji so drops look like pumps
    const visuallyUp = deluluActive ? !isUp : isUp;
    const emoji = visuallyUp ? upEmoji : downEmoji;
    const bodySize = Math.abs(c.close - c.open);
    const emojiCount = Math.max(MIN_EMOJIS, Math.round((bodySize / maxBody) * MAX_EMOJIS));

    const bodyTopPx = candlePriceToPx(Math.max(c.open, c.close));
    const bodyBottomPx = candlePriceToPx(Math.min(c.open, c.close));
    const highPx = candlePriceToPx(c.high);
    const lowPx = candlePriceToPx(c.low);

    // In DeLuLu mode positions are inverted, so recalculate which is top/bottom
    const actualTop = Math.max(bodyTopPx, bodyBottomPx, highPx, lowPx);
    const actualBottom = Math.min(bodyTopPx, bodyBottomPx, highPx, lowPx);
    const bodyHigh = Math.max(bodyTopPx, bodyBottomPx);
    const bodyLow = Math.min(bodyTopPx, bodyBottomPx);

    const upperWick = actualTop - bodyHigh;
    const lowerWick = bodyLow - actualBottom;
    const bottomOffset = actualBottom;

    let emojis = '';
    const emojiFontSize = 14 * zoomLevel;
    const emojiLineHeight = 16 * zoomLevel;
    for (let i = 0; i < emojiCount; i++) {
      emojis += `<span class="emoji" style="font-size:${emojiFontSize}px;line-height:${emojiLineHeight}px;height:${emojiLineHeight}px;">${emoji}</span>`;
    }

    const candleMinWidth = 22 * zoomLevel;
    candlesHtml += `
      <div class="candle-col" style="min-width:${candleMinWidth}px;">
        <div class="candle-inner" style="margin-bottom:${bottomOffset}px;">
          <div class="wick" style="height:${Math.max(0, upperWick)}px;"></div>
          <div class="candle-body">${emojis}</div>
          <div class="wick" style="height:${Math.max(0, lowerWick)}px;"></div>
        </div>
      </div>`;

    const showLabel = shouldShowLabel(c.time, idx);
    xAxisHtml += `<div class="x-label-cell" style="min-width:${candleMinWidth}px;">${showLabel ? formatTime(c.time) : ''}</div>`;
  });

  const currentPrice = candles[candles.length - 1].close;
  // In DeLuLu mode, show the boosted price
  const displayPrice = deluluActive ? (currentPrice + deluluBoost) : currentPrice;

  chartEl.className = 'chart-grid';
  chartEl.innerHTML = `
    <div class="candles-scroll" id="candlesScroll">
      <div class="candles-area" style="height:${SCALED_HEIGHT}px;gap:${2 * zoomLevel}px;">${candlesHtml}</div>
    </div>
    <div class="y-axis">
      <div class="y-axis-inner" style="height:${SCALED_HEIGHT}px;">
        ${yAxisHtml}
        <div class="price-tag" style="bottom:${candlePriceToPx(currentPrice)}px;"><div class="price-tag-label">${formatPrice(displayPrice)}</div></div>
      </div>
    </div>
    <div class="x-axis-scroll" id="xAxisScroll">
      <div class="x-axis" style="gap:${2 * zoomLevel}px;">${xAxisHtml}</div>
    </div>
    <div class="chart-corner"></div>`;

  const candlesScroll = document.getElementById('candlesScroll');
  const xAxisScroll = document.getElementById('xAxisScroll');
  const yAxisInner = document.querySelector('.y-axis-inner');

  // Scroll restoration
  if (pendingScrollRestore) {
    candlesScroll.scrollLeft = pendingScrollRestore.scrollLeft;
    candlesScroll.scrollTop = pendingScrollRestore.scrollTop;
    pendingScrollRestore = null;
  } else {
    // Default: scroll to right edge, position current price in center of viewport
    candlesScroll.scrollLeft = candlesScroll.scrollWidth;
    // Calculate where current price candle is and center on it
    const currentPricePx = candlePriceToPx(currentPrice);
    const viewportHeight = candlesScroll.clientHeight;
    // currentPricePx is from bottom, scrollTop is from top, so invert
    const targetScrollTop = (SCALED_HEIGHT - currentPricePx) - (viewportHeight / 2);
    candlesScroll.scrollTop = Math.max(0, Math.min(targetScrollTop, candlesScroll.scrollHeight - viewportHeight));
  }
  xAxisScroll.scrollLeft = candlesScroll.scrollLeft;
  yAxisInner.style.transform = `translateY(-${candlesScroll.scrollTop}px)`;

  candlesScroll.addEventListener('scroll', () => {
    xAxisScroll.scrollLeft = candlesScroll.scrollLeft;
    yAxisInner.style.transform = `translateY(-${candlesScroll.scrollTop}px)`;
  });

  // Y-axis touch drag to scroll vertically
  const yAxis = document.querySelector('.y-axis');
  let yAxisDragging = false;
  let yAxisStartY = 0;
  let yAxisStartScroll = 0;
  yAxis.addEventListener('touchstart', (e) => {
    yAxisDragging = true;
    yAxisStartY = e.touches[0].clientY;
    yAxisStartScroll = candlesScroll.scrollTop;
  }, { passive: true });
  yAxis.addEventListener('touchmove', (e) => {
    if (!yAxisDragging) return;
    const deltaY = yAxisStartY - e.touches[0].clientY;
    candlesScroll.scrollTop = yAxisStartScroll + deltaY;
  }, { passive: true });
  yAxis.addEventListener('touchend', () => { yAxisDragging = false; });

  // X-axis touch drag to scroll horizontally
  let xAxisDragging = false;
  let xAxisStartX = 0;
  let xAxisStartScroll = 0;
  xAxisScroll.addEventListener('touchstart', (e) => {
    xAxisDragging = true;
    xAxisStartX = e.touches[0].clientX;
    xAxisStartScroll = candlesScroll.scrollLeft;
  }, { passive: true });
  xAxisScroll.addEventListener('touchmove', (e) => {
    if (!xAxisDragging) return;
    const deltaX = xAxisStartX - e.touches[0].clientX;
    candlesScroll.scrollLeft = xAxisStartScroll + deltaX;
  }, { passive: true });
  xAxisScroll.addEventListener('touchend', () => { xAxisDragging = false; });

  // Continuous wheel/trackpad zoom with focal point
  candlesScroll.addEventListener('wheel', (e) => {
    if (!e.ctrlKey) return;
    e.preventDefault();

    const oldZoom = zoomLevel;
    const newZoom = Math.min(3, Math.max(0.5, zoomLevel * (1 - e.deltaY * 0.01)));
    if (newZoom === oldZoom) return;

    // Cursor position relative to scroll container viewport
    const rect = candlesScroll.getBoundingClientRect();
    const cursorX = e.clientX - rect.left;
    const cursorY = e.clientY - rect.top;

    // Content-space coordinate under cursor
    const contentX = candlesScroll.scrollLeft + cursorX;
    const contentY = candlesScroll.scrollTop + cursorY;

    // Ratio within old content
    const oldContentWidth = candlesScroll.scrollWidth;
    const oldContentHeight = candlesScroll.scrollHeight;
    const ratioX = oldContentWidth > 0 ? contentX / oldContentWidth : 0;
    const ratioY = oldContentHeight > 0 ? contentY / oldContentHeight : 0;

    zoomLevel = newZoom;

    // Estimate new content dimensions based on zoom ratio
    const zoomRatio = newZoom / oldZoom;
    const newContentWidth = oldContentWidth * zoomRatio;
    const newContentHeight = oldContentHeight * zoomRatio;

    pendingScrollRestore = {
      scrollLeft: ratioX * newContentWidth - cursorX,
      scrollTop: ratioY * newContentHeight - cursorY,
    };

    scheduleRender();
  }, { passive: false });

  // Touch pinch-to-zoom with focal point
  candlesScroll.addEventListener('touchstart', (e) => {
    if (e.touches.length === 2) {
      const dx = e.touches[0].clientX - e.touches[1].clientX;
      const dy = e.touches[0].clientY - e.touches[1].clientY;
      touchStartDist = Math.hypot(dx, dy);
      touchStartZoom = zoomLevel;

      // Record midpoint and scroll state
      const rect = candlesScroll.getBoundingClientRect();
      touchMidX = (e.touches[0].clientX + e.touches[1].clientX) / 2 - rect.left;
      touchMidY = (e.touches[0].clientY + e.touches[1].clientY) / 2 - rect.top;
      touchScrollLeft = candlesScroll.scrollLeft;
      touchScrollTop = candlesScroll.scrollTop;
      touchContentWidth = candlesScroll.scrollWidth;
      touchContentHeight = candlesScroll.scrollHeight;
    }
  });
  candlesScroll.addEventListener('touchmove', (e) => {
    if (e.touches.length === 2 && touchStartDist) {
      e.preventDefault();
      const dx = e.touches[0].clientX - e.touches[1].clientX;
      const dy = e.touches[0].clientY - e.touches[1].clientY;
      const dist = Math.hypot(dx, dy);
      const newZoom = Math.min(3, Math.max(0.5, touchStartZoom * (dist / touchStartDist)));
      if (newZoom === zoomLevel) return;

      // Content coordinate under original midpoint
      const contentX = touchScrollLeft + touchMidX;
      const contentY = touchScrollTop + touchMidY;
      const ratioX = touchContentWidth > 0 ? contentX / touchContentWidth : 0;
      const ratioY = touchContentHeight > 0 ? contentY / touchContentHeight : 0;

      const zoomRatio = newZoom / touchStartZoom;
      const newContentWidth = touchContentWidth * zoomRatio;
      const newContentHeight = touchContentHeight * zoomRatio;

      // Current midpoint (fingers may have moved)
      const rect = candlesScroll.getBoundingClientRect();
      const curMidX = (e.touches[0].clientX + e.touches[1].clientX) / 2 - rect.left;
      const curMidY = (e.touches[0].clientY + e.touches[1].clientY) / 2 - rect.top;

      zoomLevel = newZoom;
      pendingScrollRestore = {
        scrollLeft: ratioX * newContentWidth - curMidX,
        scrollTop: ratioY * newContentHeight - curMidY,
      };
      scheduleRender();
    }
  }, { passive: false });
  candlesScroll.addEventListener('touchend', () => {
    touchStartDist = null;
    touchStartZoom = null;
  });
}

// --- WebSocket for 1m real-time ---
let ws = null;

function closeWebSocket() {
  if (ws) {
    ws.onclose = null;
    ws.close();
    ws = null;
  }
}

function connectBinanceWs() {
  return new Promise((resolve, reject) => {
    const sock = new WebSocket(`wss://stream.binance.com:9443/ws/${COINS[currentCoin].binance.toLowerCase()}@kline_1m`);
    const timeout = setTimeout(() => { sock.close(); reject(new Error('timeout')); }, 5000);
    sock.onopen = () => { clearTimeout(timeout); resolve(sock); };
    sock.onerror = () => { clearTimeout(timeout); reject(new Error('binance ws failed')); };
  });
}

function connectKrakenWs() {
  return new Promise((resolve, reject) => {
    const sock = new WebSocket('wss://ws.kraken.com/v2');
    const timeout = setTimeout(() => { sock.close(); reject(new Error('timeout')); }, 5000);
    sock.onopen = () => {
      clearTimeout(timeout);
      sock.send(JSON.stringify({
        method: 'subscribe',
        params: { channel: 'ohlc', symbol: [COINS[currentCoin].krakenWs], interval: 1 }
      }));
      resolve(sock);
    };
    sock.onerror = () => { clearTimeout(timeout); reject(new Error('kraken ws failed')); };
  });
}

function handleBinanceMessage(evt) {
  const msg = JSON.parse(evt.data);
  if (!msg.k) return;
  const k = msg.k;
  // k.t is the candle open time (start of the minute)
  applyRealtimeCandle({
    time: k.t,
    open: parseFloat(k.o),
    high: parseFloat(k.h),
    low: parseFloat(k.l),
    close: parseFloat(k.c),
  });
}

function handleKrakenMessage(evt) {
  const msg = JSON.parse(evt.data);
  if (msg.channel !== 'ohlc' || !msg.data || !msg.data.length) return;
  const k = msg.data[0];
  // Kraken timestamp is end of interval; floor to minute start
  const ts = new Date(k.timestamp).getTime();
  const minuteStart = Math.floor(ts / 60000) * 60000;
  applyRealtimeCandle({
    time: minuteStart,
    open: parseFloat(k.open),
    high: parseFloat(k.high),
    low: parseFloat(k.low),
    close: parseFloat(k.close),
  });
}

function applyRealtimeCandle(updatedCandle) {
  if (!candles.length) return;
  const last = candles[candles.length - 1];
  const lastMinute = Math.floor(last.time / 60000);
  const updMinute = Math.floor(updatedCandle.time / 60000);

  // Preserve scroll position so user doesn't get yanked to the front
  const candlesScroll = document.getElementById('candlesScroll');
  if (candlesScroll) {
    pendingScrollRestore = {
      scrollLeft: candlesScroll.scrollLeft,
      scrollTop: candlesScroll.scrollTop,
    };
  }

  if (updMinute === lastMinute) {
    // Update current candle in place
    candles[candles.length - 1] = updatedCandle;
  } else if (updMinute > lastMinute) {
    // New minute â€” add new candle, drop oldest
    candles.push(updatedCandle);
    if (candles.length > LIMIT) candles.shift();
  }
  renderChart();
}

async function startWebSocket() {
  closeWebSocket();
  if (currentInterval !== '1m') return;

  try {
    ws = await connectBinanceWs();
    ws.onmessage = handleBinanceMessage;
    ws.onclose = () => { setTimeout(startWebSocket, 3000); };
    dataSource = 'Binance';
    updateSourceLabel();
  } catch (e) {
    try {
      ws = await connectKrakenWs();
      ws.onmessage = handleKrakenMessage;
      ws.onclose = () => { setTimeout(startWebSocket, 3000); };
      dataSource = 'Kraken';
      updateSourceLabel();
    } catch (e2) {
      // Both failed â€” retry after a delay
      setTimeout(startWebSocket, 5000);
    }
  }
}

async function fetchAndRender() {
  chartEl.className = 'loading';
  chartEl.innerHTML = 'Loading...';
  try {
    candles = await fetchCandles();
    renderChart();
    startWebSocket();
  } catch (e) {
    chartEl.className = 'loading';
    chartEl.innerHTML = `<span class="error">Failed to load data: ${e.message}</span>`;
  }
}

fetchAndRender();
</script>
</body>
</html>
